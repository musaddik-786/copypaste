Thanks — that 404 + {"detail":"Not Found"} means the HTTP request reached a running FastAPI server but there is no route registered at the exact URL you requested. I’ll fix this and give you a simpler, reliable main.py + test_scripts.py you can run right away (avoids FastApiMCP mounting complexity which often causes path confusion). I’ll also give quick troubleshooting checks so you can confirm things step-by-step.

Quick checklist (why 404 usually happens)
	1.	The FastAPI server isn’t running (or crashed) — check console where you ran python main.py / uvicorn.
	2.	The route path you used in test_scripts.py doesn’t match the route registered by FastAPI.
	3.	The app was mounted under a subpath (e.g. /api/v1/layout_agent) but the request used a different path.
	4.	FastApiMCP sometimes mounts internal paths; for now we’ll skip it to avoid confusion.

⸻

What I changed
	•	Provide a simplified main.py that registers the router at /api/v1/layout_agent and does not use FastApiMCP.
	•	Ensure the router path is exactly /layout_detection_mcp so your test script URL http://localhost:8601/api/v1/layout_agent/layout_detection_mcp will succeed.
	•	Provide a test script that calls that exact URL.
	•	Add a small health-check endpoint so you can verify the server is up quickly.

Save the following files and run them exactly in this order.

⸻

1) main.py (replace your current main.py with this)

# main.py
import uvicorn
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware

from file_router import router as file_router

def create_app():
    app = FastAPI(title="Layout Detection MCP (simple)")
    app.add_middleware(
        CORSMiddleware,
        allow_origins=["*"],
        allow_methods=["*"],
        allow_headers=["*"],
    )

    # health-check
    @app.get("/health")
    async def health():
        return {"status": "ok"}

    # mount sub app routes under this prefix
    app.include_router(file_router, prefix="/api/v1/layout_agent")
    return app

app = create_app()

if __name__ == "__main__":
    # run with uvicorn in-process for convenience
    uvicorn.run("main:app", host="0.0.0.0", port=8601, reload=False)


⸻

2) file_router.py (ensure this file exists and the route path matches)

Make sure file_router.py is in the same folder and has the following. (If you already have it, just ensure @router.post("/layout_detection_mcp") is present — this must match.)

# file_router.py
from fastapi import APIRouter
from fastapi.responses import JSONResponse
from pydantic import BaseModel, Field
from handler import process_pdf_layout

router = APIRouter()

class PDFLayoutRequest(BaseModel):
    blob_url: str = Field(..., description="Azure Blob URL of the PDF file")

@router.post(
    "/layout_detection_mcp",
    operation_id="layout_detection_mcp",
    summary="Detect document layout as structured or unstructured using GPT-4o."
)
async def detect_layout(request: PDFLayoutRequest):
    try:
        result = await process_pdf_layout(request.blob_url)
        # normalize final response shape to exactly {"result": "structured"} or {"result": "unstructured"}
        if isinstance(result, dict) and "result" in result:
            return JSONResponse(content={"result": result["result"]}, status_code=200)
        # if handler returned error
        if isinstance(result, dict) and "error" in result:
            return JSONResponse(content={"error": result["error"]}, status_code=500)
        return JSONResponse(content={"error": "unexpected handler response"}, status_code=500)
    except Exception as e:
        return JSONResponse(content={"error": str(e)}, status_code=500)


⸻

3) test_scripts.py (replace existing)

# test_scripts.py
import requests
import json

BASE_URL = "http://localhost:8601/api/v1/layout_agent/layout_detection_mcp"

def run_test():
    payload = {
        "blob_url": "https://youraccount.blob.core.windows.net/yourcontainer/sample.pdf"
    }

    try:
        resp = requests.post(BASE_URL, json=payload, timeout=120)
        print("HTTP Status:", resp.status_code)
        try:
            print(json.dumps(resp.json(), indent=4))
        except Exception:
            print("Non-JSON response:", resp.text)
    except Exception as e:
        print("Request error:", str(e))

if __name__ == "__main__":
    run_test()


⸻

How to run (step-by-step)
	1.	Open a terminal in the project root.
	2.	Start the server:
	•	(venv) PS> python main.py
	•	You should see uvicorn logs and it should say it’s listening on 0.0.0.0:8601.
	3.	Verify health endpoint (quick check):
	•	In another terminal run:
	•	curl http://localhost:8601/health
	•	Expect: {"status":"ok"}
	•	If this returns 404, server is not running or running on different port.
	4.	Run the test script:
	•	(venv) PS> python test_scripts.py
	•	You should now get HTTP Status: 200 and either {"result":"structured"} or {"result":"unstructured"} (or an error if something else failed).

⸻

Extra troubleshooting tips if you still get 404
	•	Make sure you restarted the server after changing main.py. (Stop the previous process and start python main.py.)
	•	Confirm port 8601 is not in use by another process.
	•	Confirm file_router.py is in the same folder and that the import from handler import process_pdf_layout succeeds (no import errors on startup).
	•	If imports fail, uvicorn will show stacktrace and the server may not have registered routes.
	•	Check the server console where you started python main.py — if there was an import error, you’ll see a traceback there. Fix that before calling the test script.
	•	If you previously used FastApiMCP and left it in code, remove/replace as above — FastApiMCP can change the exposed path.

⸻

Why I removed FastApiMCP for now

You previously used the FastApiMCP(file_app, include_operations=[...]).mount_http() approach. That can create a different path mapping depending on that library’s internals. Removing it gives deterministic, straightforward routing and eliminates the source of the 404.

If you prefer FastApiMCP (for MCP discovery), I can put it back once everything is working. For now this simplified approach will let you test the download → convert → GPT-4o call flow reliably.

⸻

If you want, I will:
	•	Provide a minimal logging wrapper so you can see each step (download succeeded, image saved, LLM response) in the server console.
	•	Or, if you prefer to keep FastApiMCP, I can show the exact FastApiMCP mounting that will register /api/v1/eligibility_agent/mcp or whatever path you require — but first let’s confirm this simple flow works for you.

Tell me to proceed with logs or to keep the FastApiMCP version — otherwise run the steps above and paste any server console error you see and I’ll fix it immediately.
