#!/usr/bin/env python3
"""
analyze_local.py

Run this file directly:
    python analyze_local.py

It will:
  ‚Ä¢ Read .env for ENDPOINT, KEY, MODEL_ID
  ‚Ä¢ Analyze 'input.pdf' from the same folder
  ‚Ä¢ Save exact JSON (same as Azure Studio) as 'output.json'
"""

import os
import json
from dotenv import load_dotenv
from azure.core.credentials import AzureKeyCredential
from azure.ai.documentintelligence import DocumentIntelligenceClient


def main():
    # 1Ô∏è‚É£ Load .env
    load_dotenv()
    endpoint = os.getenv("ENDPOINT")
    key = os.getenv("KEY")
    model_id = os.getenv("MODEL_ID")

    if not (endpoint and key and model_id):
        raise ValueError("Missing ENDPOINT, KEY, or MODEL_ID in .env file.")

    # 2Ô∏è‚É£ Define default file paths
    input_path = os.path.join(os.getcwd(), "input.pdf")
    output_path = os.path.join(os.getcwd(), "output.json")

    if not os.path.exists(input_path):
        raise FileNotFoundError(
            f"‚ùå Could not find 'input.pdf' in {os.getcwd()}.\n"
            f"Please place your document there and re-run: python analyze_local.py"
        )

    # 3Ô∏è‚É£ Create Azure client
    print("üîó Connecting to Azure Document Intelligence service...")
    client = DocumentIntelligenceClient(
        endpoint=endpoint,
        credential=AzureKeyCredential(key)
    )

    # 4Ô∏è‚É£ Analyze document
    print(f"üìÑ Analyzing '{input_path}' using model '{model_id}'...")
    with open(input_path, "rb") as f:
        poller = client.begin_analyze_document(model_id=model_id, document=f)
        result = poller.result()

    # 5Ô∏è‚É£ Save exact JSON output
    print("üíæ Saving results as 'output.json'...")
    json_data = result.to_dict()
    with open(output_path, "w", encoding="utf-8") as wf:
        json.dump(json_data, wf, indent=2, ensure_ascii=False)

    print("\n‚úÖ Done!")
    print(f"üìÇ Input file:  {input_path}")
    print(f"üìÅ Output file: {output_path}")
    print("You can open 'output.json' to see the same JSON as in Azure Studio.\n")


if __name__ == "__main__":
    main()
